---
title: ""
author: ""
output:
  html_document:
    css: custom.css
---

`r format(Sys.time(), '%B %d, %Y')`

![](./snowflake.png)

<style>
body {text-align: justify}
</style>

<br>

# Heading One

## Heading Two

### Heading Three

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint o

```{r setup, include = FALSE}

knitr::opts_chunk$set(
  echo = FALSE,
  out.width = "100%",
  fig.asp = 0.8,
  fig.align = "center",
  message = FALSE,
  warning = FALSE
)

library(tidyverse)
library(lubridate)
library(RColorBrewer)
library(ggsci)
library(DBI)

theme_set(theme_minimal())

```

```{r snowflake}

snow_db <-
  #connections::connection_open(
  DBI::dbConnect(
    odbc::odbc(),
    Driver       = "/opt/snowflake/snowflakeodbc/lib/universal/libSnowflake.dylib",
    Server       = "lha61820.snowflakecomputing.com",
    UID          = rstudioapi::askForPassword("Please enter your username"),
    PWD          = rstudioapi::askForPassword("Please enter your password"),
    Database     = "FIVETRAN_DATABASE",
    Warehouse    = "FIVETRAN_WAREHOUSE",
    Schema       = "SALESFORCESNOWFLAKE"
  )

```

```{r}

summary_data <- 
  snow_db %>% 
  dbGetQuery(
    "
      select -- summary of Snowflake data
        min(RECEIVED_DATE_TIME_C) as `from`,
        max(RECEIVED_DATE_TIME_C) as `to`,
        SAMPLE_TYPE_C as sample_type,
        count(*) as samples
      from
        SALESFORCESNOWFLAKE.LIMS_SAMPLE_C
      group by
        SAMPLE_TYPE_C
      order by
        samples desc
    "
  )

controls <-
  snow_db %>% 
  dbGetQuery(
    "
      select -- controls Cq performance (2022)
        SAMPLE_BARCODE_C as barcode,
        CREATED_DATE as created_date,
        SAMPLE_TYPE_C as sample_type,
        CALL_C as call,
        N_1_CQ_1_C as n1,
        N_2_CQ_1_C as n2,
        RP_CQ_1_C as rp
      from
        SALESFORCESNOWFLAKE.LIMS_SAMPLE_C
      where
        RECEIVED_DATE_TIME_C like '%2022%'
          and
        SAMPLE_TYPE_C not in ('Clinical Samples', 'Filler')  
    "
  )

controls %>% jsonlite::write_json("controls.json")

aggregated <- 
  snow_db %>% 
  dbGetQuery(
    "
      select -- aggregate quality data by week (2022)
        weekofyear(RECEIVED_DATE_TIME_C) as week,
        SAMPLE_TYPE_C as sample_type,
        CALL_C as call,
        count(*) as no_samples
        -- TODO as retest_perc, (?)
        -- TODO as inconclusive_perc,
        -- TODO as invalid_perc,
        -- TODO as positive_perc
      from
        SALESFORCESNOWFLAKE.LIMS_SAMPLE_C
      where
        RECEIVED_DATE_TIME_C like '%2022%'
      group by week, SAMPLE_TYPE_C, CALL_C
      order by week, SAMPLE_TYPE_C, CALL_C 
    "
  )

aggregated %>% jsonlite::write_json("aggregated.json")

```