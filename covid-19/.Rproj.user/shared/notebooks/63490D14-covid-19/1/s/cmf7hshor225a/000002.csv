"0",""
"0","# data analysis functions"
"0",""
"0","get_state <- function(state_name) {"
"0","  s <- states[states$state == state_name, ] # state object"
"0",""
"0","  s <- s %>%"
"0","    mutate("
"0","      ncases = cases - lag(cases, default = cases[1]),"
"0","      ndeaths = deaths - lag(deaths, default = deaths[1])"
"0","    )"
"0",""
"0","  s"
"0","}"
"0",""
"0","get_county <- function(county_name, state_name) {"
"0","  c <- counties %>%"
"0","    filter(county == county_name, state == state_name) # county object"
"0",""
"0","  if (nrow(c) > 1) {"
"0","    c <- c %>%"
"0","      mutate("
"0","        ncases = cases - lag(cases, default = cases[1]),"
"0","        ndeaths = deaths - lag(deaths, default = deaths[1])"
"0","      )"
"0","  }"
"0",""
"0","  c"
"0","}"
"0",""
"0","covid <- function(state_name = ""United States"") {"
"0","  if (state_name == ""United States"") {"
"0","    s <- us"
"0","    chart_caption <- ""(data from nytimes)"""
"0","  }"
"0","  else {"
"0","    s <- get_state(state_name)"
"0","    chart_caption <- """""
"0","  }"
"0",""
"0","  # output stats"
"0","  print(str_glue(""{state_name} has {format(s$cases[nrow(s)], big.mark = ',')} cases "","
"0","                 ""({format(s$ncases[nrow(s)], big.mark = ',')} cases per day) and "","
"0","                 ""{format(s$deaths[nrow(s)], big.mark = ',')} deaths "","
"0","                 ""({format(s$ndeaths[nrow(s)], big.mark = ',')} deaths per day)."""
"0","        )"
"0","  )"
"0",""
"0","  # display new cases and new deaths"
"0","  scale_d <- 7"
"0",""
"0","  p <- ggplot(data = s, mapping = aes(x = date)) +"
"0","    geom_smooth(aes(y = ndeaths * scale_d),"
"0","      se = FALSE,"
"0","      color = ""#868686"", fill = ""grey85"","
"0","      method = ""gam"", formula = y ~ s(x, bs = ""cs""), level = 0.9,"
"0","      na.rm = TRUE"
"0","    ) +"
"0","    geom_smooth(aes(y = ncases),"
"0","      se = FALSE,"
"0","      color = ""#868686"", fill = ""grey85"","
"0","      method = ""gam"", formula = y ~ s(x, bs = ""cs""), level = 0.9,"
"0","      na.rm = TRUE"
"0","    ) +"
"0","    geom_point(aes(y = ndeaths * scale_d, fill = sec_color),"
"0","      shape = 21, color = ""black"","
"0","      size = 1.5, na.rm = TRUE, alpha = 0.8"
"0","    ) +"
"0","    geom_point(aes(y = ncases, fill = prim_color),"
"0","      shape = 21, color = ""black"","
"0","      size = 1.5, na.rm = TRUE, alpha = 0.8"
"0","    ) +"
"0","    labs("
"0","      title = state_name,"
"0","      x = """","
"0","      y = ""cases (change)"","
"0","      fill = """","
"0","      caption = chart_caption"
"0","    ) +"
"0","    scale_y_continuous("
"0","      labels = scales::comma,"
"0","      sec.axis = sec_axis(~ . / scale_d,"
"0","                          name = ""deaths (change)"","
"0","                          labels = scales::comma"
"0","                 )"
"0","    ) +"
"0","    coord_cartesian(xlim = as.Date(c(""2020-03-01"","
"0","                                     Sys.Date()"
"0","                                     ),"
"0","                                   origin = ""1960-10-01"""
"0","                           ),"
"0","                    ylim = c(0, max(s$ncases))"
"0","    ) +"
"0","    scale_fill_manual("
"0","      labels = c(""deaths"", ""cases""),"
"0","      values = c(prim_color, sec_color)"
"0","    ) +"
"0","    theme("
"0","      legend.position = ""bottom"","
"0","      text = element_text(size = 10)"
"0","    )"
"0",""
"0","  p"
"0","}"
"0",""
"0","covidc <- function(county_state) {"
"0","  county_name <- str_trim(str_split_fixed(county_state, "","", n = 2)[1])"
"0","  state_name <- str_trim(str_split_fixed(county_state, "","", n = 2)[2])"
"0",""
"0",""
"0","  c <- get_county(county_name, state_name)"
"0",""
"0","  # output stats"
"0","  print(str_glue(""{county_name} County, {state_name} has "","
"0","                 ""{format(c$cases[nrow(c)], big.mark = ',')} cases "","
"0","                 ""({format(c$ncases[nrow(c)], big.mark = ',')} cases per day) and "","
"0","                 ""{format(c$deaths[nrow(c)], big.mark = ',')} deaths "","
"0","                 ""({format(c$ndeaths[nrow(c)], big.mark = ',')} deaths per day)."""
"0","        )"
"0","  )"
"0",""
"0","  # display new cases and new deaths"
"0","  scale_d <- 7"
"0",""
"0","  p <- ggplot(data = c, mapping = aes(x = date)) +"
"0","    geom_smooth(aes(y = ndeaths * scale_d),"
"0","      se = FALSE,"
"0","      color = ""#868686"", fill = ""grey85"","
"0","      method = ""gam"", formula = y ~ s(x, bs = ""cs""), level = 0.9,"
"0","      na.rm = TRUE"
"0","    ) +"
"0","    geom_smooth(aes(y = ncases),"
"0","      se = FALSE,"
"0","      color = ""#868686"", fill = ""grey85"","
"0","      method = ""gam"", formula = y ~ s(x, bs = ""cs""), level = 0.9,"
"0","      na.rm = TRUE"
"0","    ) +"
"0","    geom_point(aes(y = ndeaths * scale_d, fill = sec_color),"
"0","      shape = 21, color = ""black"","
"0","      size = 1.5, na.rm = TRUE, alpha = 0.8"
"0","    ) +"
"0","    geom_point(aes(y = ncases, fill = prim_color),"
"0","      shape = 21, color = ""black"","
"0","      size = 1.5, na.rm = TRUE, alpha = 0.8"
"0","    ) +"
"0","    labs("
"0","      title = str_glue(""{county_name} County, {state_name}""),"
"0","      x = """","
"0","      y = ""cases (change)"","
"0","      fill = """""
"0","    ) +"
"0","    scale_x_date(limits = as.Date(c(""2020-03-01"","
"0","                                    Sys.Date()"
"0","                                    ),"
"0","                                  origin = ""1960-10-01"""
"0","                          )"
"0","    ) +"
"0","    scale_y_continuous("
"0","      labels = scales::comma,"
"0","      sec.axis = sec_axis(~ . / scale_d,"
"0","                          name = ""deaths (change)"","
"0","                          labels = scales::comma"
"0","                 )"
"0","    ) +"
"0","    coord_cartesian(xlim = as.Date(c(""2020-03-01"","
"0","                                     Sys.Date()"
"0","                                     ),"
"0","                                   origin = ""1960-10-01"""
"0","                           ),"
"0","                    ylim = c(0, max(c$ncases))"
"0","    ) +"
"0","    scale_fill_manual("
"0","      labels = c(""deaths"", ""cases""),"
"0","      values = c(prim_color, sec_color)"
"0","    ) +"
"0","    theme("
"0","      legend.position = ""bottom"","
"0","      text = element_text(size = 10)"
"0","    )"
"0",""
"0","  p"
"0","}"
"0",""
"0","covid_total <- function(state_name = ""United States"") {"
"0","  if (state_name == ""United States"") {"
"0","    s <- us"
"0","    chart_caption <- ""(data from nytimes)"""
"0","  }"
"0","  else {"
"0","    s <- get_state(state_name)"
"0","    chart_caption <- """""
"0","  }"
"0",""
"0","  # display new cases and new deaths"
"0","  scale_d <- 7"
"0",""
"0","  p <- ggplot(data = s, mapping = aes(x = date)) +"
"0","    geom_area("
"0","      aes(y = cases, fill = prim_color),"
"0","      na.rm = TRUE,"
"0","      alpha = 0.8,"
"0","      color = ""black"""
"0","    ) +"
"0","    geom_area("
"0","      aes(y = deaths * scale_d, fill = sec_color),"
"0","      na.rm = TRUE,"
"0","      alpha = 1.0,"
"0","      color = ""black"""
"0","    ) +"
"0","    labs("
"0","      title = state_name,"
"0","      x = """","
"0","      y = ""cases"","
"0","      fill = """","
"0","      caption = chart_caption"
"0","    ) +"
"0","    scale_y_continuous("
"0","      labels = scales::comma,"
"0","      sec.axis = sec_axis(~ . / scale_d,"
"0","                          name = ""deaths"","
"0","                          labels = scales::comma"
"0","                 )"
"0","    ) +"
"0","    coord_cartesian(xlim = as.Date(c(""2020-03-15"","
"0","                                     Sys.Date()"
"0","                                     ),"
"0","                                   origin = ""1960-10-01"""
"0","                           ),"
"0","                    ylim = c(0, max(s$cases))"
"0","    ) +"
"0","    scale_fill_manual("
"0","      labels = c(""deaths"", ""cases""),"
"0","      values = c(prim_color, sec_color)"
"0","    ) +"
"0","    theme("
"0","      legend.position = ""bottom"","
"0","      text = element_text(size = 10)"
"0","    )"
"0",""
"0","  p"
"0","}"
"0",""
"0","covidc_total <- function(county_state) {"
"0","  county_name <- str_trim(str_split_fixed(county_state, "","", n = 2)[1])"
"0","  state_name <- str_trim(str_split_fixed(county_state, "","", n = 2)[2])"
"0",""
"0",""
"0","  c <- get_county(county_name, state_name)"
"0",""
"0","  # display new cases and new deaths"
"0","  scale_d <- 7"
"0",""
"0","  p <- ggplot(data = c, mapping = aes(x = date)) +"
"0","   geom_area("
"0","      aes(y = cases, fill = prim_color),"
"0","      na.rm = TRUE,"
"0","      alpha = 0.8,"
"0","      color = ""black"""
"0","    ) +"
"0","    geom_area("
"0","      aes(y = deaths * scale_d, fill = sec_color),"
"0","      na.rm = TRUE,"
"0","      alpha = 1.0,"
"0","      color = ""black"""
"0","    ) + "
"0","    labs("
"0","      title = str_glue(""{county_name} County, {state_name}""),"
"0","      x = """","
"0","      y = ""cases"","
"0","      fill = """""
"0","    ) +"
"0","    scale_x_date(limits = as.Date(c(""2020-03-01"","
"0","                                    Sys.Date()"
"0","                                    ),"
"0","                                  origin = ""1960-10-01"""
"0","                          )"
"0","    ) +"
"0","    scale_y_continuous("
"0","      labels = scales::comma,"
"0","      sec.axis = sec_axis(~ . / scale_d,"
"0","                          name = ""deaths"","
"0","                          labels = scales::comma"
"0","                 )"
"0","    ) +"
"0","    coord_cartesian(xlim = as.Date(c(""2020-03-01"","
"0","                                     Sys.Date()"
"0","                                     ),"
"0","                                   origin = ""1960-10-01"""
"0","                           ),"
"0","                    ylim = c(0, max(c$cases))"
"0","    ) +"
"0","    scale_fill_manual("
"0","      labels = c(""deaths"", ""cases""),"
"0","      values = c(prim_color, sec_color)"
"0","    ) +"
"0","    theme("
"0","      legend.position = ""bottom"","
"0","      text = element_text(size = 10)"
"0","    )"
"0",""
"0","  p"
"0","}"
"0",""
"0","calculate_risk_estimate_state <- function(state_name) {"
"0","  s <- get_state(state_name)"
"0",""
"0","  # data to be used for fitting linear regression model"
"0","  reg_data <- top_n(s, 10, date)"
"0",""
"0","  # linear regression model"
"0","  reg_model <- lsfit(reg_data$date, reg_data$ncases)"
"0",""
"0","  return(reg_model$coefficients[""X""]) # return slope of ncases rate"
"0","}"
"0","calculate_risk_estimate_state_c <- compiler::cmpfun(calculate_risk_estimate_state)"
"0",""
"0","calculate_risk_estimate_county <- function(county_name, state_name) {"
"0","  c <- get_county(county_name, state_name) # county object"
"0",""
"0","  if (nrow(c) > 20) {"
"0","    # data to be used for fitting linear regression model"
"0","    reg_data <- top_n(c, 10, date)"
"0",""
"0","    # linear regression model"
"0","    reg_model <- lsfit(reg_data$date, reg_data$ncases)"
"0",""
"0","    return(reg_model$coefficients[""X""]) # return slope of ncases rate"
"0","  }"
"0",""
"0","  return(0)"
"0","}"
"0","calculate_risk_estimate_county_c <- compiler::cmpfun(calculate_risk_estimate_county)"
