"0",""
"0","# data analysis functions"
"0",""
"0","get_country <- function(country_name) {"
"0","  c <- global_cases %>%"
"0","    filter(country == country_name)  # country object"
"0",""
"0","  c <- c %>%"
"0","    mutate("
"0","      ncases = cases - lag(cases, default = cases[1])"
"0","    )"
"0",""
"0","  c"
"0","}"
"0",""
"0","get_state <- function(state_name) {"
"0","  s <- states[states$state == state_name, ] # state object"
"0",""
"0","  s <- s %>%"
"0","    mutate("
"0","      ncases = cases - lag(cases, default = cases[1]),"
"0","      ndeaths = deaths - lag(deaths, default = deaths[1])"
"0","    )"
"0",""
"0","  s"
"0","}"
"0",""
"0","get_cnty <- function(cnty_name, state_name) {"
"0","  c <- counties %>%"
"0","    filter(county == cnty_name, state == state_name) # county object"
"0",""
"0","  if (nrow(c) > 1) {"
"0","    c <- c %>%"
"0","      mutate("
"0","        ncases = cases - lag(cases, default = cases[1]),"
"0","        ndeaths = deaths - lag(deaths, default = deaths[1])"
"0","      )"
"0","  }"
"0",""
"0","  c"
"0","}"
"0",""
"0","covid <- function(state_name = ""United States"") {"
"0","  if (state_name == ""United States"") {"
"0","    s <- us"
"0","  }"
"0","  else {"
"0","    s <- get_state(state_name)"
"0","  }"
"0",""
"0","  # output stats"
"0","  print(str_glue(""{state_name} has {format(s$cases[nrow(s)], big.mark = ',')} cases "","
"0","                 ""({format(s$ncases[nrow(s)], big.mark = ',')} cases per day) and "","
"0","                 ""{format(s$deaths[nrow(s)], big.mark = ',')} deaths "","
"0","                 ""({format(s$ndeaths[nrow(s)], big.mark = ',')} deaths per day)."""
"0","        )"
"0","  )"
"0",""
"0","  # display new cases and new deaths"
"0","  scale_d <- 7"
"0",""
"0","  p <- ggplot(data = s, mapping = aes(x = date)) +"
"0","    geom_smooth("
"0","      aes(y = ndeaths * scale_d),"
"0","      se = FALSE,"
"0","      color = ""#808080"","
"0","      method = ""gam"", formula = y ~ s(x, bs = ""cs""), level = 0.9,"
"0","      na.rm = TRUE"
"0","    ) +"
"0","    geom_smooth("
"0","      aes(y = ncases),"
"0","      se = FALSE,"
"0","      color = prim_color,"
"0","      method = ""gam"", formula = y ~ s(x, bs = ""cs""), level = 0.9,"
"0","      na.rm = TRUE"
"0","    ) +"
"0","    geom_point("
"0","      aes(y = ndeaths * scale_d, color = prim_color),  # unclear why color reversal is required"
"0","      size = 0.8, na.rm = TRUE, alpha = 0.8"
"0","    ) +"
"0","    geom_point("
"0","      aes(y = ncases, color = ""#808080""),  # unclear why color reversal is required"
"0","      size = 0.8, na.rm = TRUE, alpha = 0.8"
"0","    ) +"
"0","    labs("
"0","      subtitle = state_name,"
"0","      x = """","
"0","      y = ""cases (change)"","
"0","      color = """""
"0","    ) +"
"0","    scale_y_continuous("
"0","      labels = scales::comma,"
"0","      sec.axis = sec_axis(~ . / scale_d,"
"0","                          name = ""deaths (change)"","
"0","                          labels = scales::comma"
"0","                 )"
"0","    ) +"
"0","    coord_cartesian(xlim = as.Date(c(""2020-03-01"","
"0","                                     Sys.Date()"
"0","                                     ),"
"0","                                   origin = ""1960-10-01"""
"0","                           ),"
"0","                    ylim = c(0, max(s$ncases))"
"0","    ) +"
"0","    scale_color_manual("
"0","      labels = c(""deaths"", ""cases""),"
"0","      values = c(""#808080"", prim_color),"
"0","      guide = FALSE"
"0","    ) +"
"0","    theme("
"0","      #axis.text.y = element_text(color = prim_color),"
"0","      axis.title.y = element_text(color = prim_color),"
"0","      #axis.text.y.right = element_text(color = ""#808080""),"
"0","      axis.title.y.right = element_text(color = ""#808080"")"
"0","    )"
"0",""
"0","  p"
"0","}"
"0",""
"0","covidc <- function(county_state) {"
"0","  cnty_name <- str_trim(str_split_fixed(county_state, "","", n = 2)[1])"
"0","  state_name <- str_trim(str_split_fixed(county_state, "","", n = 2)[2])"
"0",""
"0",""
"0","  c <- get_cnty(cnty_name, state_name)"
"0",""
"0","  # output stats"
"0","  print(str_glue(""{cnty_name} County, {state_name} has "","
"0","                 ""{format(c$cases[nrow(c)], big.mark = ',')} cases "","
"0","                 ""({format(c$ncases[nrow(c)], big.mark = ',')} cases per day) and "","
"0","                 ""{format(c$deaths[nrow(c)], big.mark = ',')} deaths "","
"0","                 ""({format(c$ndeaths[nrow(c)], big.mark = ',')} deaths per day)."""
"0","        )"
"0","  )"
"0",""
"0","  # display new cases and new deaths"
"0","  scale_d <- 7"
"0",""
"0","  p <- ggplot(data = c, mapping = aes(x = date)) +"
"0","    geom_smooth("
"0","      aes(y = ndeaths * scale_d),"
"0","      se = FALSE,"
"0","      color = ""#808080"","
"0","      method = ""gam"", formula = y ~ s(x, bs = ""cs""), level = 0.9,"
"0","      na.rm = TRUE"
"0","    ) +"
"0","    geom_smooth("
"0","      aes(y = ncases),"
"0","      se = FALSE,"
"0","      color = prim_color,"
"0","      method = ""gam"", formula = y ~ s(x, bs = ""cs""), level = 0.9,"
"0","      na.rm = TRUE"
"0","    ) +"
"0","    geom_point("
"0","      aes(y = ndeaths * scale_d, color = prim_color),  # unclear why color reversal is required"
"0","      size = 0.8, na.rm = TRUE, alpha = 0.8"
"0","    ) +"
"0","    geom_point("
"0","      aes(y = ncases, color = ""#808080""),  # unclear why color reversal is required"
"0","      size = 0.8, na.rm = TRUE, alpha = 0.8"
"0","    ) +"
"0","    labs("
"0","      subtitle = str_glue(""{cnty_name} County, {state_name}""),"
"0","      x = """","
"0","      y = ""cases (change)"","
"0","      color = """""
"0","    ) +"
"0","    scale_x_date(limits = as.Date(c(""2020-03-01"","
"0","                                    Sys.Date()"
"0","                                    ),"
"0","                                  origin = ""1960-10-01"""
"0","                          )"
"0","    ) +"
"0","    scale_y_continuous("
"0","      labels = scales::comma,"
"0","      sec.axis = sec_axis(~ . / scale_d,"
"0","                          name = ""deaths (change)"","
"0","                          labels = scales::comma"
"0","                 )"
"0","    ) +"
"0","    coord_cartesian(xlim = as.Date(c(""2020-03-01"","
"0","                                     Sys.Date()"
"0","                                     ),"
"0","                                   origin = ""1960-10-01"""
"0","                           ),"
"0","                    ylim = c(0, max(c$ncases))"
"0","    ) +"
"0","    scale_color_manual("
"0","      labels = c(""deaths"", ""cases""),"
"0","      values = c(""#808080"", prim_color),"
"0","      guide = FALSE"
"0","    ) +"
"0","    theme("
"0","      #axis.text.y = element_text(color = prim_color),"
"0","      axis.title.y = element_text(color = prim_color),"
"0","      #axis.text.y.right = element_text(color = ""#808080""),"
"0","      axis.title.y.right = element_text(color = ""#808080"")"
"0","    )"
"0",""
"0","  p"
"0","}"
"0",""
"0","covid_total <- function(state_name = ""United States"") {"
"0","  if (state_name == ""United States"") {"
"0","    s <- us"
"0","  }"
"0","  else {"
"0","    s <- get_state(state_name)"
"0","  }"
"0",""
"0","  # display new cases and new deaths"
"0","  scale_d <- 7"
"0",""
"0","  p <- ggplot(data = s, mapping = aes(x = date)) +"
"0","    geom_area("
"0","      aes(y = cases, fill = ""#808080""),"
"0","      na.rm = TRUE,"
"0","      alpha = 0.8"
"0","    ) +"
"0","    geom_area("
"0","      aes(y = deaths * scale_d, fill = prim_color),"
"0","      na.rm = TRUE,"
"0","      alpha = 0.9"
"0","    ) +"
"0","    labs("
"0","      subtitle = state_name,"
"0","      x = """","
"0","      y = ""cases (cumulative)"","
"0","      fill = """""
"0","    ) +"
"0","    scale_y_continuous("
"0","      labels = scales::comma,"
"0","      sec.axis = sec_axis(~ . / scale_d,"
"0","                          name = ""deaths (cumulative)"","
"0","                          labels = scales::comma"
"0","                 )"
"0","    ) +"
"0","    coord_cartesian(xlim = as.Date(c(""2020-03-15"","
"0","                                     Sys.Date()"
"0","                                     ),"
"0","                                   origin = ""1960-10-01"""
"0","                           ),"
"0","                    ylim = c(0, max(s$cases))"
"0","    ) +"
"0","    scale_fill_manual("
"0","      labels = c(""deaths"", ""cases""),"
"0","      values = c(""#808080"", prim_color),"
"0","      guide = FALSE"
"0","    ) +"
"0","    theme("
"0","      #axis.text.y = element_text(color = prim_color),"
"0","      axis.title.y = element_text(color = prim_color),"
"0","      #axis.text.y.right = element_text(color = ""#808080""),"
"0","      axis.title.y.right = element_text(color = ""#808080"")"
"0","    )"
"0",""
"0","  p"
"0","}"
"0",""
"0","covidc_total <- function(county_state) {"
"0","  cnty_name <- str_trim(str_split_fixed(county_state, "","", n = 2)[1])"
"0","  state_name <- str_trim(str_split_fixed(county_state, "","", n = 2)[2])"
"0",""
"0",""
"0","  c <- get_cnty(cnty_name, state_name)"
"0",""
"0","  # display new cases and new deaths"
"0","  scale_d <- 7"
"0",""
"0","  p <- ggplot(data = c, mapping = aes(x = date)) +"
"0","   geom_area("
"0","      aes(y = cases, fill = ""#808080""),"
"0","      na.rm = TRUE,"
"0","      alpha = 0.8"
"0","    ) +"
"0","    geom_area("
"0","      aes(y = deaths * scale_d, fill = prim_color),"
"0","      na.rm = TRUE,"
"0","      alpha = 0.9"
"0","    ) +"
"0","    labs("
"0","      subtitle = str_glue(""{cnty_name} County, {state_name}""),"
"0","      x = """","
"0","      y = ""cases (cumulative)"","
"0","      fill = """""
"0","    ) +"
"0","    scale_x_date(limits = as.Date(c(""2020-03-01"","
"0","                                    Sys.Date()"
"0","                                    ),"
"0","                                  origin = ""1960-10-01"""
"0","                          )"
"0","    ) +"
"0","    scale_y_continuous("
"0","      labels = scales::comma,"
"0","      sec.axis = sec_axis(~ . / scale_d,"
"0","                          name = ""deaths (cumulative)"","
"0","                          labels = scales::comma"
"0","                 )"
"0","    ) +"
"0","    coord_cartesian(xlim = as.Date(c(""2020-03-01"","
"0","                                     Sys.Date()"
"0","                                     ),"
"0","                                   origin = ""1960-10-01"""
"0","                           ),"
"0","                    ylim = c(0, max(c$cases))"
"0","    ) +"
"0","    scale_fill_manual("
"0","      labels = c(""deaths"", ""cases""),"
"0","      values = c(""#808080"", prim_color),"
"0","      guide = FALSE"
"0","    ) +"
"0","    theme("
"0","      #axis.text.y = element_text(color = prim_color),"
"0","      axis.title.y = element_text(color = prim_color),"
"0","      #axis.text.y.right = element_text(color = ""#808080""),"
"0","      axis.title.y.right = element_text(color = ""#808080"")"
"0","    )"
"0",""
"0","  p"
"0","}"
"0",""
"0","calculate_risk_prediction_country <- function(country_name) {"
"0","  c <- get_country(country_name)"
"0",""
"0","  # data to be used for fitting linear regression model"
"0","  reg_data <- top_n(c, 12, date)"
"0",""
"0","  # linear regression model"
"0","  reg_model <- lsfit(reg_data$date, reg_data$ncases)"
"0",""
"0","  return(reg_model$coefficients[""X""]) # return slope of ncases rate"
"0","}"
"0","calculate_risk_prediction_country_c <- compiler::cmpfun(calculate_risk_prediction_country)"
"0",""
"0","calculate_risk_prediction_state <- function(state_name) {"
"0","  s <- get_state(state_name)"
"0",""
"0","  # data to be used for fitting linear regression model"
"0","  reg_data <- top_n(s, 12, date)"
"0",""
"0","  # linear regression model"
"0","  reg_model <- lsfit(reg_data$date, reg_data$ncases)"
"0",""
"0","  return(reg_model$coefficients[""X""]) # return slope of ncases rate"
"0","}"
"0","calculate_risk_prediction_state_c <- compiler::cmpfun(calculate_risk_prediction_state)"
"0",""
"0","calculate_risk_prediction_cnty <- function(cnty_name, state_name) {"
"0","  c <- get_cnty(cnty_name, state_name) # county object"
"0",""
"0","  if (nrow(c) > 20) {"
"0","    # data to be used for fitting linear regression model"
"0","    reg_data <- top_n(c, 12, date)"
"0",""
"0","    # linear regression model"
"0","    reg_model <- lsfit(reg_data$date, reg_data$ncases)"
"0",""
"0","    return(reg_model$coefficients[""X""]) # return slope of ncases rate"
"0","  }"
"0",""
"0","  return(0)"
"0","}"
"0","calculate_risk_prediction_cnty_c <- compiler::cmpfun(calculate_risk_prediction_cnty)"
"0",""
