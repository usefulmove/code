"0","### data analysis functions ###"
"0",""
"0","getState <- function( state_name ) {"
"0",""
"0","    s <- states[ states$state == state_name, ]  # state object"
"0",""
"0","    s <- mutate( s, ncases=vector(""integer"", nrow(s)), ndeaths=vector(""integer"", nrow(s)) )"
"0","    for ( i in 2:nrow(s) ) {  # calculate new cases and new deaths"
"0","        s$ncases[i] <- s$cases[i] - s$cases[i-1]"
"0","        s$ndeaths[i] <- s$deaths[i] - s$deaths[i-1]"
"0","    }"
"0",""
"0","    s"
"0","}"
"0",""
"0","getCounty <- function( county_name, state_name ) {"
"0",""
"0","    c <- filter( counties, county == county_name, state == state_name )  # county object"
"0",""
"0","    c <- mutate( c, ncases=vector(""integer"", nrow(c)), ndeaths=vector(""integer"", nrow(c)) )"
"0",""
"0","    if (nrow(c) > 1) {"
"0","        for ( i in 2:nrow(c) ) {  # calculate new cases and new deaths"
"0","            c$ncases[i] <- c$cases[i] - c$cases[i-1]"
"0","            c$ndeaths[i] <- c$deaths[i] - c$deaths[i-1]"
"0","        }"
"0","    }"
"0",""
"0","    c"
"0","}"
"0",""
"0","overall <- function( state_name=""United States"" ) {"
"0",""
"0","    if ( state_name==""United States"" ) {"
"0","        s <- us"
"0","        chart_caption <- ""(data from nytimes)"""
"0","    }"
"0","    else {"
"0","        s <- getState( state_name )"
"0","        chart_caption <- """""
"0","    }"
"0",""
"0","    # output stats"
"0","    print( paste( state_name, "" has "","
"0","        format( s$cases[ nrow(s) ], big.mark="","" ), "" cases ("","
"0","        format( s$ncases[ nrow(s) ], big.mark="","" ), "" cases per day) and "","
"0","        format( s$deaths[ nrow(s) ], big.mark="","" ), "" deaths ("","
"0","        format( s$ndeaths[ nrow(s) ], big.mark="","" ), "" deaths per day)."","
"0","        sep="""") )"
"0",""
"0","    # display new cases and new deaths"
"0","    scale_d <- 5"
"0","    "
"0","    p <- ggplot( data=s, mapping=aes( x=date ) ) +"
"0","        geom_area( aes( y=cases, fill=""#ff9933"" ),"
"0","                   na.rm=TRUE, alpha=0.8 ) +"
"0","        geom_area( aes( y=deaths*scale_d, fill=""#6db96b"" ),"
"0","                   na.rm=TRUE, alpha=0.8 ) +"
"0","        labs("
"0","            title=paste( state_name ),"
"0","            x="""","
"0","            y=""cases"","
"0","            fill="""","
"0","            caption=chart_caption"
"0","        ) +"
"0","        scale_y_continuous( labels=scales::comma,"
"0","                            sec.axis = sec_axis( ~ ./scale_d, name=""deaths"", labels=scales::comma )"
"0","                            ) +"
"0","        coord_cartesian( xlim = as.Date( c( ""2020-03-15"", Sys.Date() ), origin=""1960-10-01"" ), ylim = c( 0, max(s$cases) ) ) +"
"0","        scale_fill_manual( labels=c(""deaths"",""cases""),"
"0","                            values=c(""#ff9933"",""#6db96b"")"
"0","                            ) +"
"0","        theme( legend.position=""bottom"","
"0","               text = element_text(size=10)"
"0","               )"
"0",""
"0","    p"
"0","}"
"0",""
"0","covid <- function( state_name=""United States"" ) {"
"0",""
"0","    if ( state_name==""United States"" ) {"
"0","        s <- us"
"0","        chart_caption <- ""(data from nytimes)"""
"0","    }"
"0","    else {"
"0","        s <- getState( state_name )"
"0","        chart_caption <- """""
"0","    }"
"0",""
"0","    # output stats"
"0","    print( paste( state_name, "" has "","
"0","        format( s$cases[ nrow(s) ], big.mark="","" ), "" cases ("","
"0","        format( s$ncases[ nrow(s) ], big.mark="","" ), "" cases per day) and "","
"0","        format( s$deaths[ nrow(s) ], big.mark="","" ), "" deaths ("","
"0","        format( s$ndeaths[ nrow(s) ], big.mark="","" ), "" deaths per day)."","
"0","        sep="""") )"
"0",""
"0","    # display new cases and new deaths"
"0","    scale_d <- 5"
"0","    "
"0","    p <- ggplot( data=s, mapping=aes( x=date ) ) +"
"0","        geom_smooth( aes( y=ndeaths*scale_d ),"
"0","                     color=""darkgrey"", fill=""grey85"","
"0","                     method=""gam"", formula=y~s(x,bs=""cs""), level=0.9,"
"0","                     size=0.8, na.rm=TRUE ) +"
"0","        geom_smooth( aes( y=ncases ),"
"0","                     color=""darkgrey"", fill=""grey85"","
"0","                     method=""gam"", formula=y~s(x,bs=""cs""), level=0.9,"
"0","                     na.rm=TRUE ) +"
"0","        geom_point( aes( y=ndeaths*scale_d, fill=sec_color ),"
"0","                    shape=21, color=""black"","
"0","                    size = 2, na.rm=TRUE, alpha=0.8 ) +"
"0","        geom_point( aes( y=ncases, fill=prim_color ),"
"0","                    shape=21, color=""black"","
"0","                    size = 2, na.rm=TRUE, alpha=0.8 ) +"
"0","        labs("
"0","            title=paste( state_name ),"
"0","            x="""","
"0","            y=""cases (change)"","
"0","            fill="""","
"0","            caption=chart_caption"
"0","        ) +"
"0","        scale_y_continuous( labels=scales::comma,"
"0","                            sec.axis = sec_axis( ~ ./scale_d, name=""deaths (change)"", labels=scales::comma )"
"0","                            ) +"
"0","        coord_cartesian( xlim = as.Date( c( ""2020-03-01"", Sys.Date() ), origin=""1960-10-01"" ), ylim = c( 0, max(s$ncases) ) ) +"
"0","        scale_fill_manual( labels=c(""deaths"",""cases""),"
"0","                            values=c(prim_color,sec_color)"
"0","                            ) +"
"0","        theme( legend.position=""bottom"","
"0","               text = element_text(size=10)"
"0","               )"
"0",""
"0","    p"
"0","}"
"0",""
"0","overall.c <- function( county_state ) {"
"0",""
"0","    county_name <- str_trim( str_split_fixed( county_state, "","", n=2 )[1] )"
"0","    state_name <- str_trim( str_split_fixed( county_state, "","", n=2 )[2] )"
"0",""
"0",""
"0","    c <- getCounty( county_name, state_name )"
"0",""
"0","    # output stats"
"0","    print( paste( county_name, "" County, "", state_name, "" has "","
"0","        format( c$cases[ nrow(c) ], big.mark="","" ), "" cases ("","
"0","        format( c$ncases[ nrow(c) ], big.mark="","" ), "" cases per day) and "","
"0","        format( c$deaths[ nrow(c) ], big.mark="","" ), "" deaths ("","
"0","        format( c$ndeaths[ nrow(c) ], big.mark="","" ), "" deaths per day)."","
"0","        sep="""") )"
"0",""
"0","    # display new cases and new deaths"
"0","    scale_d <- 5"
"0","    "
"0","    p <- ggplot( data=c, mapping=aes( x=date ) ) +"
"0","        geom_area( aes( y=cases, fill=""#ff9933"" ),"
"0","                   na.rm=TRUE, alpha=0.8 ) +"
"0","        geom_area( aes( y=deaths*scale_d, fill=""#6db96b"" ),"
"0","                   na.rm=TRUE, alpha=0.8 ) +"
"0","        labs("
"0","            title=paste( county_name, ""County,"", state_name ),"
"0","            x="""","
"0","            y=""cases"","
"0","            fill="""""
"0","        ) +"
"0","        scale_x_date( limits = as.Date( c( ""2020-03-01"", Sys.Date() ), origin=""1960-10-01"" ) ) +"
"0","        scale_y_continuous( labels=scales::comma,"
"0","                            sec.axis = sec_axis( ~ ./scale_d, name=""deaths"", labels=scales::comma )"
"0","                            ) +"
"0","        coord_cartesian( xlim = as.Date( c( ""2020-03-01"", Sys.Date() ), origin=""1960-10-01"" ), ylim = c( 0, max(c$cases) ) ) +"
"0","        scale_fill_manual( labels=c(""deaths"",""cases""),"
"0","                            values=c(""#ff9933"",""#6db96b"")"
"0","                            ) +"
"0","        theme( legend.position=""bottom"","
"0","               text = element_text(size=10)"
"0","               )"
"0",""
"0","    p"
"0","}"
"0",""
"0","covid.c <- function( county_state ) {"
"0",""
"0","    county_name <- str_trim( str_split_fixed( county_state, "","", n=2 )[1] )"
"0","    state_name <- str_trim( str_split_fixed( county_state, "","", n=2 )[2] )"
"0",""
"0",""
"0","    c <- getCounty( county_name, state_name )"
"0",""
"0","    # output stats"
"0","    print( paste( county_name, "" County, "", state_name, "" has "","
"0","        format( c$cases[ nrow(c) ], big.mark="","" ), "" cases ("","
"0","        format( c$ncases[ nrow(c) ], big.mark="","" ), "" cases per day) and "","
"0","        format( c$deaths[ nrow(c) ], big.mark="","" ), "" deaths ("","
"0","        format( c$ndeaths[ nrow(c) ], big.mark="","" ), "" deaths per day)."","
"0","        sep="""") )"
"0",""
"0","    # display new cases and new deaths"
"0","    scale_d <- 5"
"0","    "
"0","    p <- ggplot( data=c, mapping=aes( x=date ) ) +"
"0","        geom_smooth( aes( y=ndeaths*scale_d ),"
"0","                     color=""darkgrey"", fill=""grey85"","
"0","                     method=""gam"", formula=y~s(x,bs=""cs""), level=0.9,"
"0","                     size=0.8, na.rm=TRUE ) +"
"0","        geom_smooth( aes( y=ncases ),"
"0","                     color=""darkgrey"", fill=""grey85"","
"0","                     method=""gam"", formula=y~s(x,bs=""cs""), level=0.9,"
"0","                     na.rm=TRUE ) +"
"0","        geom_point( aes( y=ndeaths*scale_d, fill=sec_color ),"
"0","                    shape=21, color=""black"","
"0","                    size = 2, na.rm=TRUE, alpha=0.8 ) +"
"0","        geom_point( aes( y=ncases, fill=prim_color ),"
"0","                    shape=21, color=""black"","
"0","                    size = 2, na.rm=TRUE, alpha=0.8 ) +"
"0","        labs("
"0","            title=paste( county_name, ""County,"", state_name ),"
"0","            x="""","
"0","            y=""cases (change)"","
"0","            fill="""""
"0","        ) +"
"0","        scale_x_date( limits = as.Date( c( ""2020-03-01"", Sys.Date() ), origin=""1960-10-01"" ) ) +"
"0","        scale_y_continuous( labels=scales::comma,"
"0","                            sec.axis = sec_axis( ~ ./scale_d, name=""deaths (change)"", labels=scales::comma )"
"0","                            ) +"
"0","        coord_cartesian( xlim = as.Date( c( ""2020-03-01"", Sys.Date() ), origin=""1960-10-01"" ), ylim = c( 0, max(c$ncases) ) ) +"
"0","        scale_fill_manual( labels=c(""deaths"",""cases""),"
"0","                            values=c(prim_color,sec_color)"
"0","                            ) +"
"0","        theme( legend.position=""bottom"","
"0","               text = element_text(size=10)"
"0","               )"
"0",""
"0","    p"
"0","}"
"0",""
"0","getStateCaseRate <- function( state_name ) {"
"0",""
"0","    s <- getState( state_name )"
"0",""
"0","    # data to be used for fitting linear regression model"
"0","    reg_data <- select( top_n(s, 10, date), date, ncases )"
"0",""
"0","    # linear regression model"
"0","    reg_model <- lsfit( reg_data$date, reg_data$ncases )"
"0",""
"0","    return( reg_model$coefficients[""X""] )  # return slope of ncases rate"
"0",""
"0","}"
"0",""
"0","getCountyCaseRate <- function( county_name, state_name ) {"
"0",""
"0","    c <- getCounty( county_name, state_name )  # county object"
"0",""
"0","    if (nrow(c) > 20) {"
"0","        # data to be used for fitting linear regression model"
"0","        cnty_reg_data <- select( top_n(c, 10, date), date, ncases )"
"0",""
"0","        # linear regression model"
"0","        reg_model <- lsfit( cnty_reg_data$date, cnty_reg_data$ncases )"
"0",""
"0","        return( reg_model$coefficients[""X""] )  # return slope of ncases rate"
"0","        "
"0","    } else {"
"0","        return(0)"
"0","    }"
"0",""
"0","}"
"0",""
